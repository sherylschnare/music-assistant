rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // Allow reading user documents for login, but restrict writes.
    match /users/{userId} {
      allow list, get: if true;
      allow create: if request.auth.token.role == 'Music Director';
      allow update: if request.auth.uid == userId || request.auth.token.role == 'Music Director';
      allow delete: if request.auth.token.role == 'Music Director';
    }

    // Allow authenticated users to read music data.
    // Only Music Directors and Librarians can write.
    match /songs/{songId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (request.auth.token.role == 'Music Director' || request.auth.token.role == 'Librarian');
    }

    // Allow authenticated users to read concert data.
    // Only Music Directors and Librarians can write.
    match /concerts/{concertId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && (request.auth.token.role == 'Music Director' || request.auth.token.role == 'Librarian');
    }

    // Allow authenticated users to read taxonomy.
    // Only Music Directors can write.
    match /app-data/taxonomy {
       allow read: if request.auth != null;
       allow write: if request.auth != null && request.auth.token.role == 'Music Director';
    }
  }
}
